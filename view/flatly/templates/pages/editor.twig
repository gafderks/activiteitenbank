{% extends "layout.twig" %}

{% block title %}{{ activity ? 'Edit activity' : 'New activity' }}{% endblock title %}

{% block stylesheets %}
{{ parent() }}

<link href="//cdnjs.cloudflare.com/ajax/libs/summernote/0.7.3/summernote.css" rel="stylesheet">

{% endblock stylesheets %}

{% block content %}

<h1>{{ activity ? 'Edit activity' : 'New activity' }}</h1>

<input type="hidden" id="activity-id" value="{{ activity ? activity.id }}" />

<div class="row">
    <div class="col-xs-12 col-md-8">
        <label for="activity-title">Name</label>
        <input type="text" class="form-control" placeholder="Name" value="{{ activity.name ? activity.name }}" id="activity-title" />

        {% include 'partials/editor/wizard.twig' %}

        {% include 'partials/editor/activity_areas.twig' %}

        {% include 'partials/editor/suitable_groups.twig' %}
    </div><!-- /'left side' -->

    <div id="" class="sidebar col-xs-12 col-md-4">
        <div class="row">
            <div class="col-xs-12 col-sm-6 col-md-12">
                {% include 'partials/editor/properties.twig' %}
            </div>

            <div class="col-xs-12 col-sm-6 col-md-12">
                {% include 'partials/editor/save.twig' %}
            </div>
        </div>
    </div>
</div>


{% endblock content %}

{% block javascripts %}
{{ parent() }}

<script src="//cdnjs.cloudflare.com/ajax/libs/summernote/0.7.3/summernote.js"></script>
<script src="{{ assetsUrl }}/js/save-activity.js"></script>
<script src="{{ assetsUrl }}/js/list.js"></script>

<script type="text/javascript">

    $(".activity-property-edit").click(function() {
        $($(this).data("property-editor")).addClass("active");
        $(this).hide();
    });

    $(".activity-property-cancel").click(function() {
        $($(this).data("property-editor")).removeClass("active");
        $($(this).data("property-edit")).show();
    });


    $(".activity-prop-ok").click(function() {

        // set field
        $($(this).data("prop-field")).val($('input[name='+$(this).data("prop-radio")+']:checked').val());

        // set label
        $($(this).data("prop-label")).text($('input[name='+$(this).data("prop-radio")+']:checked').data("prop-text"));

        // hide editor
        $($(this).data("prop-editor")).removeClass("active");

        $($(this).data("property-edit")).show();
    });

    $(document).ready(function() {
        if(window.location.hash) {
            if($(window.location.hash+".wizard-content").length > 0) {
                $(".wizard-label").removeClass("active");
                $(".wizard-content").removeClass("active");
                $(window.location.hash).addClass("active");
                $("li[data-wizard-tab="+window.location.hash.slice(1)+"]").addClass("active");

                // disable scrolling
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 1);
            }
        }
    });




    $(".badge-selectors>li>label>input[type=checkbox]").change(function() {
        $(this).parent().parent().toggleClass("active");

    });


    $(".badge-selectors>li>label>input[type=checkbox]:checked").parent().parent().addClass("active");



    $(".wizard-label").click(function(e) {

        e.preventDefault();
        var hash = $(this).attr("data-wizard-tab");
        window.location.hash = "#"+hash;

        $(".wizard-label").removeClass("active");
        $(".wizard-content").removeClass("active");

        $(this).addClass("active");
        $("#"+$(this).attr("data-wizard-tab")).addClass("active");

        return false;
    });

    $(".wysiwyg-extended").summernote({
        height: 250,
        toolbar: [
            //[groupname, [button list]]
            ['', ['style']],
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['font', ['strikethrough']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['misc', ['fullscreen', 'codeview']],
            ['insert', ['picture', 'video', 'link', 'table']],
        ]
    });



    $("#save-button").click(function() {
        $("#save-button").attr("disabled", "disabled");
        $("#status-saving").show();
        console.log("clicked");
        $.ajax({
                    type: "POST",
                    url: "<?php echo RootURL(); ?>/ajax/activity-processor.php",
                    data: { action: "save", activity: updateActivity() }
                })
                .done(function( msg ) {
                    console.log( msg );
                    if (msg.status == 'OK') {
                        window.location.href = "<?php echo RootURL(); ?>/edit/"+msg.data.id+"/"+msg.data.slug;
                    } else {
                        alert("Saving failed...");
                    }

                })
                .fail(function (a, b) {
                    console.log("No luck..." + b);
                    alert("Saving failed...");
                    $("#save-button").removeAttr("disabled");
                });

    });


    $("#update-button").click(function() {
        $("#update-button").attr("disabled", "disabled");
        $("#status-saving").show();
        console.log("clicked");
        $.ajax({
                    type: "POST",
                    url: "<?php echo RootURL(); ?>/ajax/activity-processor.php",
                    data: { action: "save", activity: updateActivity() }
                })
                .done(function( msg ) {
                    console.log( msg );
                    if (msg.status == 'OK') {
                        $("#update-button").removeAttr("disabled");
                        $("#status-saving").hide();
                        $("#status-saved").show();
                        setTimeout(function() { $("#status-saved").fadeOut(); }, 2000);

                    } else {
                        $("#update-button").removeAttr("disabled");
                        $("#status-saving").hide();
                        alert("Saving failed...");
                    }
                })
                .fail(function (a, b) {
                    console.log("No luck..." + b);
                    $("#status-saving").hide();
                    alert("Saving failed...");
                    $("#update-button").removeAttr("disabled");
                });

    });

    </script>

{% endblock javascripts %}